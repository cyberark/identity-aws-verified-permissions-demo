# Examples to configure Amazon Verified Permissions with CybnerArk Identity
This directory contains examples of configuration files for Amazon Verified Permissions with CyberArk Identity.
The "examples\identity-source" directory contains the following files:
* redirect_server.py - this script opens is a web server in local machine port 5000.
This application should be registered in CyberArk Identity. 
* token_login_authorize.py - this script is used to get the token from the redirect server and launch an authorization call to 
Amazon Verified Permissions. The example logins to CyberArk Identity using a client ID and client secret.
The result is an ID Token and Access token that is used to call Amazon Verified Permissions.
The call to Amazon Verified Permissions is done using the **is_authorized_with_token** function. 
The result s a JSON object with the permissions.


## Setup the Policy stores with the schema and identity source for an ID and Access token
Here is the command to create 
1. Create multiple stores - one for an ID token and one for an Access token
2. Update the cedar schema per policy store
3. Set the Identity source for the policy store

``` bash
cd examples/identity-source

./deploy_policy_store.sh 
```
This is the expected output of the script:
``` bash
deploying a Policy store with schema and identity source for ID and Access Token

Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - avp-identity-source-stack
IdTokenPolicyStoreId: yyyy
AccessTokenPolicyStoreId: zzzz
{
    "createdDate": "2024-06-16T11:16:29.349765+00:00",
    "identitySourceId": "xxxx",
    "lastUpdatedDate": "2024-06-16T11:16:29.349765+00:00",
    "policyStoreId": "yyyy"
}
{
    "createdDate": "2024-06-16T11:16:32.989147+00:00",
    "identitySourceId": "wwww",
    "lastUpdatedDate": "2024-06-16T11:16:32.989147+00:00",
    "policyStoreId": "zzzz"
}
```

#Identity source examples
The ***examples/identity-source/config*** directory contains the following examples

## Policy Store schema files for ID Token and Access Token
An example of policy store schema files for an ID and Access token are in the confid directory: 
* **id-token-schema.json** - a schema file mapping between the ID token claims and the user attributes
* **access-token-schema.json** - a schema file mapping between the access token claims and the user attributes


## Identity Source configuration files
Here are the example configuration files for and ID token and access token as identity sources for the policy store: 
* identity-source-config-id-token.json - configuration file for the ID token as an identity source for the policy store
* identity-source-config-access-token.json - configuration file for the access token as an identity source for the policy store

## Example Cedar policies for ID and Access Tokens
* **id-token-policy** - a policy file that defines the policies in the policy store. It is written in Cedar Policy Language (CPL)
* **access-token-policy** - a policy file that defines the policies in the policy store. It is written in Cedar Policy Language (CPL)


## CyberArk Identity Token customization examples

This directory **examples/identity-source/identity-customization** contains examples of login script in Javascript
This script can set the content of claims in the ID or Access token.
it uses the following functions to set the claims in the token:
* **setClaims** - to set the claim, either a string, boolean or number 
* **setObject** - to set an object containing fields or sub-objects in the claim
* **setArray** - to set an array of values in the claim. e.g. the roles


If your AWS CLI is not at latest version, the command for creating an identity source may not be supported yet. Use the command 

```bash
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
```
