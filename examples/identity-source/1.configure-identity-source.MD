# Examples to Configure Amazon Verified Permissions with CyberArk Identity
This directory contains examples of configuration files for Amazon Verified Permissions with CyberArk Identity.
The "examples/identity-source" directory contains the following files:

- `redirect_server.py`: This script opens a web server on the local machine port 5000. 
The application should be registered in CyberArk Identity.
- `token_login_authorize.py`: This script is used to obtain the token from the redirect server and initiate an authorization call to 
Amazon Verified Permissions. 
The example logs in to CyberArk Identity using a client ID and client secret. 
The result is an ID Token and an Access token that are used to call Amazon Verified Permissions.
The call to Amazon Verified Permissions is made using the `is_authorized_with_token` function. 
The result is a JSON object with the permissions.

## Set Up the Policy Stores with Schema and Identity Source for an ID and Access Token

Follow these steps:

1. Create multiple stores: one for an ID token and one for an Access token.
2. Update the Cedar schema per policy store.
3. Set the Identity source for the policy store.

```bash
cd examples/identity-source
./deploy_policy_store.sh
```
The expected output of the script should be:
``` bash
deploying a Policy store with schema and identity source for ID and Access Token

Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - avp-identity-source-stack
IdTokenPolicyStoreId: yyyy
AccessTokenPolicyStoreId: zzzz
{
    "createdDate": "2024-06-16T11:16:29.349765+00:00",
    "identitySourceId": "xxxx",
    "lastUpdatedDate": "2024-06-16T11:16:29.349765+00:00",
    "policyStoreId": "yyyy"
}
{
    "createdDate": "2024-06-16T11:16:32.989147+00:00",
    "identitySourceId": "wwww",
    "lastUpdatedDate": "2024-06-16T11:16:32.989147+00:00",
    "policyStoreId": "zzzz"
}
```

#Identity source examples
The `examples/identity-source/config` directory contains the following examples

## Policy Store schema files for ID Token and Access Token
An example of policy store schema files for an ID and Access token are in the confid directory: 
* `id-token-schema.json` - A schema file mapping between the ID token claims and the user attributes.
* `access-token-schema.json` - A schema file mapping between the access token claims and the user attributes.

## Example Cedar policies for ID and Access Tokens
* `id-token-policy` - A policy file that defines the policies in the ID token policy store.  It is written in Cedar Policy Language.
* `access-token-policy` - A policy file that defines the policies in Access token the policy store. It is written in Cedar Policy Language.

## CyberArk Identity Token customization examples

The `examples/identity-source/identity-customization` directory contains examples of login scripts in JavaScript. 
These scripts can set the content of claims in the ID or Access token. They use the following functions:

`setClaims`: To set the claim (either a string, boolean, or number).
`setObject`: To set an object containing fields or sub-objects in the claim.
`setArray`: To set an array of values in the claim (e.g., the roles).


If your AWS CLI is not at latest version, the command for creating an identity source may not be supported yet. Use the command 

```bash
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
```
